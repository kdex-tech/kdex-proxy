{"version":3,"file":"index.mjs","sources":["../src/app-container.ts","../src/app-meta.ts","../src/app-route.ts","../src/app-element.ts"],"sourcesContent":["class AppContainerElement extends HTMLElement {\n  private appContainerTemplate: HTMLTemplateElement;\n\n  constructor() {\n    super();\n\n    this.appContainerTemplate = document.createElement(\"template\");\n    this.appContainerTemplate.innerHTML = `<slot><em>Application Container (placeholder)</em></slot>`;\n  }\n\n  static elementName(): string {\n    return 'kdex-ui-app-container';\n  }\n\n  connectedCallback(): void {\n    const shadowRoot = this.attachShadow({ mode: \"closed\" });\n    shadowRoot.appendChild(this.appContainerTemplate.content.cloneNode(true));\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'kdex-ui-app-container': AppContainerElement;\n  }\n}\n\nif (!customElements.get(AppContainerElement.elementName())) {\n  customElements.define(AppContainerElement.elementName(), AppContainerElement);\n}\n\nexport {\n  AppContainerElement,\n};","class UserStateSync {\n  private userState: UserState | null = null;\n  private callbacks: ((userState: UserState) => void)[] = [];\n\n  public getUserState(): UserState | null {\n    return this.userState;\n  }\n\n  public onUserStateChange(callback: (userState: UserState) => void): void {\n    if (this.userState) {\n      callback(this.userState);\n    }\n\n    this.callbacks.push(callback);\n  }\n\n  public setUserState(userState: UserState): void {\n    this.userState = userState;\n    this.callbacks.forEach(callback => callback(userState));\n  }\n\n  public unregisterUserStateChange(callback: (userState: UserState) => void): void {\n    this.callbacks = this.callbacks.filter(c => c !== callback);\n  }\n}\n\nconst userStateSync = new UserStateSync();\n\nclass AppMeta {\n  public readonly pathSeparator: string;\n  public readonly loginPath: string;\n  public readonly logoutPath: string;\n  public readonly loginLabel: string;\n  public readonly logoutLabel: string;\n  public readonly loginCssQuery: string;\n  public readonly logoutCssQuery: string;\n  public readonly stateEndpoint: string;\n\n  constructor() {\n    const kdexUIMeta = document.querySelector('html head meta[name=\"kdex-ui\"]');\n\n    if (!kdexUIMeta) {\n      throw new Error('kdex-ui meta tag not found');\n    }\n\n    this.pathSeparator = kdexUIMeta.getAttribute('data-path-separator') || '/_/';\n    this.loginPath = kdexUIMeta.getAttribute('data-login-path') || '/~/oauth/login';\n    this.logoutPath = kdexUIMeta.getAttribute('data-logout-path') || '/~/oauth/logout';\n    this.loginLabel = kdexUIMeta.getAttribute('data-login-label') || 'Login';\n    this.logoutLabel = kdexUIMeta.getAttribute('data-logout-label') || 'Logout';\n    this.loginCssQuery = kdexUIMeta.getAttribute('data-login-css-query') || 'nav.nav .nav-dropdown a.login';\n    this.logoutCssQuery = kdexUIMeta.getAttribute('data-logout-css-query') || 'nav.nav .nav-dropdown a.logout';\n    this.stateEndpoint = kdexUIMeta.getAttribute('data-state-endpoint') || '/~/state';\n\n    document.addEventListener(\"DOMContentLoaded\", () => {\n      fetch(this.stateEndpoint).then(r => r.json()).then((us: UserState) => {\n        userStateSync.setUserState(us);\n        this._setLoginLogoutLinks(us);\n      });\n    });\n  }\n\n  _setLoginLogoutLinks(us: UserState): void {\n    // a.k.a. if user is logged in\n    if (us.principal) {\n      const logoutLink = document.querySelector(this.logoutCssQuery);\n\n      if (logoutLink) {\n        logoutLink.textContent = this.logoutLabel;\n        if (logoutLink instanceof HTMLAnchorElement) {\n          logoutLink.href = this.logoutPath;\n        }\n        else {\n          logoutLink.addEventListener('click', () => {\n            const url = new URL(window.location.href);\n            url.pathname = this.logoutPath;\n            window.location.href = url.toString();\n          });\n        }\n      }\n    }\n    else {\n      const loginLink = document.querySelector(this.loginCssQuery);\n\n      if (loginLink) {\n        loginLink.textContent = this.loginLabel;\n        if (loginLink instanceof HTMLAnchorElement) {\n          loginLink.href = this.loginPath;\n        }\n        else {\n          loginLink.addEventListener('click', () => {\n            const url = new URL(window.location.href);\n            url.pathname = this.loginPath;\n            window.location.href = url.toString();\n          });\n        }\n      }\n    }\n  }\n}\n\ntype UserState = {\n  data: Record<string, any>;\n  principal: string;\n  roles: string[];\n};\n\nconst appMeta = new AppMeta();\n\nexport {\n  AppMeta,\n  appMeta,\n  UserState,\n  userStateSync,\n};\n","import {appMeta} from './app-meta';\nimport {createBrowserHistory, History} from 'history';\n\nclass AppRouteItem {\n  constructor(\n    private config: {\n      host?: HTMLElement;\n      id: string;\n      path: string;\n    }\n  ) {\n    this.host = config.host;\n    this.id = config.id;\n    this.path = config.path;\n  }\n\n  host?: HTMLElement;\n  id: string;\n  path: string;\n}\n\nclass AppRouteRegistry {\n  private items: AppRouteItem[] = [];\n  private callbacks: ((items: AppRouteItem[]) => void)[] = [];\n  private history: History;\n\n  constructor() {\n    this.history = createBrowserHistory();\n\n    this.history.listen(() => {\n      this._navigateToAppRoutePath();\n    });\n\n    document.addEventListener(\"DOMContentLoaded\", this._resetNavigationLinks.bind(this));\n    document.addEventListener(\"DOMContentLoaded\", this._navigateToAppRoutePath.bind(this));\n  }\n\n  _navigateToAppRoutePath(): void {\n    const currentRoute = this.currentRoutepath();\n    const apps = new Set(this.getItems().map(item => item.host).filter(host => host !== undefined));\n\n    for (const app of apps) {\n      if (currentRoute && app.id === currentRoute.id) {\n        app.setAttribute('route-path', `/${currentRoute.path}`);\n      }\n      else {\n        app.setAttribute('route-path', '');\n      }\n    }\n  }\n\n  _resetNavigationLinks(): void {\n    for (let link of document.querySelectorAll('a')) {\n      if (link.href.startsWith(document.location.origin + this.basepath() + appMeta.pathSeparator)) {\n        const url = new URL(link.href);\n        link.onclick = () => {\n          this.history.push(url.pathname);\n          return false;\n        };\n        link.href = 'javascript:void(0)';\n      }\n    }\n  }\n\n  addItem(item: AppRouteItem): void {\n    this.items.push(item);\n    this.callbacks.forEach(callback => callback(this.items));\n  }\n\n  basepath(): string {\n    if (window.location.pathname.includes(appMeta.pathSeparator)) {\n      return window.location.pathname.split(appMeta.pathSeparator, 2)[0];\n    }\n    if (window.location.pathname.endsWith('/')) {\n      return window.location.pathname.slice(0, -1);\n    }\n    return window.location.pathname;\n  }\n\n  currentRoutepath(): AppRouteItem | null {\n    if (window.location.pathname.includes(appMeta.pathSeparator)) {\n      const routePath = window.location.pathname.split(appMeta.pathSeparator, 2)[1];\n\n      const [id, path] = routePath.split('/', 2);\n      return new AppRouteItem({\n        id,\n        path,\n      });\n    }\n\n    return null;\n  }\n\n  findItem(id: string, path: string): AppRouteItem | null {\n    return this.items.find(item => item.id === id && item.path === path) || null;\n  }\n\n  getItems(): AppRouteItem[] {\n    return this.items;\n  }\n\n  navigate(location: string): void {\n    this.history.push(location);\n  }\n\n  onItemAdded(callback: (items: AppRouteItem[]) => void): void {\n    this.callbacks.push(callback);\n  }\n\n  registerRoutes(host: HTMLElement, ...paths: string[]): void {\n    for (const path of paths) {\n      this.addItem(new AppRouteItem({\n        host,\n        id: host.id,\n        path,\n      }));\n    }\n  }\n\n  removeItem(item: AppRouteItem): void {\n    this.items = this.items.filter(i => i !== item);\n    this.callbacks.forEach(callback => callback(this.items));\n  }\n}\n\nconst appRouteRegistry = new AppRouteRegistry();\n\nexport {\n  AppRouteItem,\n  AppRouteRegistry,\n  appRouteRegistry,\n};\n","import { AppContainerElement } from './app-container';\nimport { appMeta } from './app-meta';\nimport { appRouteRegistry } from './app-route';\n\nclass AppElement extends HTMLElement {\n  public routePath: string | null = null;\n\n  constructor() {\n    super();\n\n    const parent = this.parentElement;\n    if (!(parent instanceof AppContainerElement)) {\n      throw new Error('Parent AppContainerElement not found');\n    }\n  }\n\n  static get observedAttributes(): string[] {\n    return ['route-path'];\n  }\n\n  attributeChangedCallback(name: string, oldValue: string | null, newValue: string | null): void {\n    if (name === 'route-path') {\n      this.routePath = newValue;\n    }\n    this.connectedCallback();\n  }\n\n  basepath(): string {\n    return appRouteRegistry.basepath();\n  }\n\n  connectedCallback(): void {\n    // Default implementation - can be overridden by subclasses\n  }\n\n  navigate(path: string): void {\n    if (!path.startsWith('/')) {\n      path = `/${path}`;\n    }\n    appRouteRegistry.navigate(`${this.basepath()}${appMeta.pathSeparator}${this.id}${path}`);\n  }\n\n  registerRoutes(...paths: string[]): void {\n    if (this.id) {\n      appRouteRegistry.registerRoutes(this, ...paths);\n    }\n  }\n}\n\nexport {\n  AppElement,\n};\n"],"names":["AppContainerElement","UserStateSync","callback","userState","c","userStateSync","AppMeta","kdexUIMeta","r","us","logoutLink","url","loginLink","appMeta","AppRouteItem","config","AppRouteRegistry","createBrowserHistory","currentRoute","apps","item","host","app","link","routePath","id","path","location","paths","i","appRouteRegistry","AppElement","name","oldValue","newValue"],"mappings":"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"}